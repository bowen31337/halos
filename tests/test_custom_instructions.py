\"\"\"Test Custom Instructions feature (Feature #28).\"\"\"\n\nimport json\nimport time\nimport uuid\nfrom urllib.request import Request, urlopen\n\n# Configuration\nBACKEND_URL = \"http://localhost:8000\"\nFRONTEND_URL = \"http://localhost:5173\"\n\n\ndef test_backend_health():\n    \"\"\"Test 1: Verify backend is running.\"\"\"\n    print(\"\\n1. Testing backend health...\")\n    try:\n        req = Request(f\"{BACKEND_URL}/health\")\n        response = urlopen(req, timeout=5)\n        data = json.loads(response.read().decode())\n        assert data[\"status\"] == \"healthy\", \"Backend not healthy\"\n        print(\"   ‚úì Backend is healthy\")\n        return True\n    except Exception as e:\n        print(f\"   ‚úó Backend health check failed: {e}\")\n        return False\n\n\ndef test_create_conversation():\n    \"\"\"Test 2: Create a test conversation.\"\"\"\n    print(\"\\n2. Creating test conversation...\")\n    try:\n        req = Request(\n            f\"{BACKEND_URL}/api/conversations\",\n            data=json.dumps({\"title\": \"Custom Instructions Test\"}).encode(),\n            headers={\"Content-Type\": \"application/json\"},\n            method=\"POST\",\n        )\n        response = urlopen(req, timeout=5)\n        data = json.loads(response.read().decode())\n        assert \"id\" in data, \"No conversation ID returned\"\n        print(f\"   ‚úì Conversation created: {data['id']}\")\n        return data[\"id\"]\n    except Exception as e:\n        print(f\"   ‚úó Failed to create conversation: {e}\")\n        return None\n\n\ndef test_custom_instructions_spanish(conversation_id: str):\n    \"\"\"Test 3: Test custom instructions for Spanish response.\"\"\"\n    print(\"\\n3. Testing custom instructions: Spanish response...\")\n    try:\n        # Message with custom instructions prepended (as frontend does)\n        message_with_instructions = \"[System Instructions: Always respond in Spanish]\\n\\nHello, how are you?\"\n\n        request_data = {\n            \"message\": message_with_instructions,\n            \"conversation_id\": conversation_id,\n            \"thread_id\": str(uuid.uuid4()),\n            \"model\": \"claude-sonnet-4-5-20250929\",\n            \"extended_thinking\": False,\n        }\n\n        req = Request(\n            f\"{BACKEND_URL}/api/agent/stream\",\n            data=json.dumps(request_data).encode(),\n            headers={\"Content-Type\": \"application/json\"},\n            method=\"POST\",\n        )\n\n        response = urlopen(req, timeout=30)\n\n        # Read SSE stream\n        full_response = \"\"\n        buffer = \"\"\n        for chunk in iter(lambda: response.read(1), b\"\"):\n            buffer += chunk.decode()\n            while \"\\r\\n\\r\\n\" in buffer:\n                event_data, buffer = buffer.split(\"\\r\\n\\r\\n\", 1)\n                lines = event_data.strip().split(\"\\r\\n\")\n\n                event_type = None\n                event_json = None\n                for line in lines:\n                    if line.startswith(\"event: \"):\n                        event_type = line[7:].strip()\n                    elif line.startswith(\"data: \"):\n                        event_json = json.loads(line[6:])\n\n                if event_type == \"message\" and event_json:\n                    full_response += event_json.get(\"content\", \"\")\n\n                if event_type == \"done\":\n                    break\n\n        # Check for Spanish indicators\n        has_spanish = any(word in full_response.lower() for word in [\"hola\", \"asistente\", \"recibido\", \"mensaje\"])\n        has_english_greeting = \"hello\" in full_response.lower() or \"how are you\" in full_response.lower()\n\n        if has_spanish and not has_english_greeting:\n            print(f\"   ‚úì Spanish response detected\")\n            print(f\"   ‚úì Response: {full_response[:100]}...\")\n            return True\n        else:\n            print(f\"   ‚ö† Response may not be in Spanish\")\n            print(f\"   Response: {full_response}\")\n            return \"partial\"\n\n    except Exception as e:\n        print(f\"   ‚úó Spanish test failed: {e}\")\n        return False\n\n\ndef test_custom_instructions_formal(conversation_id: str):\n    \"\"\"Test 4: Test custom instructions for formal response.\"\"\"\n    print(\"\\n4. Testing custom instructions: Formal response...\")\n    try:\n        message_with_instructions = \"[System Instructions: Be formal]\\n\\nWhat is the weather today?\"\n\n        request_data = {\n            \"message\": message_with_instructions,\n            \"conversation_id\": conversation_id,\n            \"thread_id\": str(uuid.uuid4()),\n            \"model\": \"claude-sonnet-4-5-20250929\",\n            \"extended_thinking\": False,\n        }\n\n        req = Request(\n            f\"{BACKEND_URL}/api/agent/stream\",\n            data=json.dumps(request_data).encode(),\n            headers={\"Content-Type\": \"application/json\"},\n            method=\"POST\",\n        )\n\n        response = urlopen(req, timeout=30)\n\n        # Read SSE stream\n        full_response = \"\"\n        buffer = \"\"\n        for chunk in iter(lambda: response.read(1), b\"\"):\n            buffer += chunk.decode()\n            while \"\\r\\n\\r\\n\" in buffer:\n                event_data, buffer = buffer.split(\"\\r\\n\\r\\n\", 1)\n                lines = event_data.strip().split(\"\\r\\n\")\n\n                event_type = None\n                event_json = None\n                for line in lines:\n                    if line.startswith(\"event: \"):\n                        event_type = line[7:].strip()\n                    elif line.startswith(\"data: \"):\n                        event_json = json.loads(line[6:])\n\n                if event_type == \"message\" and event_json:\n                    full_response += event_json.get(\"content\", \"\")\n\n                if event_type == \"done\":\n                    break\n\n        # Check for formal indicators\n        has_formal = any(word in full_response.lower() for word in [\"dear\", \"sincerely\", \"shall\", \"user\"])\n\n        if has_formal:\n            print(f\"   ‚úì Formal response detected\")\n            print(f\"   ‚úì Response: {full_response[:100]}...\")\n            return True\n        else:\n            print(f\"   ‚ö† Response may not be formal\")\n            print(f\"   Response: {full_response}\")\n            return \"partial\"\n\n    except Exception as e:\n        print(f\"   ‚úó Formal test failed: {e}\")\n        return False\n\n\ndef test_custom_instructions_concise(conversation_id: str):\n    \"\"\"Test 5: Test custom instructions for concise response.\"\"\"\n    print(\"\\n5. Testing custom instructions: Concise response...\")\n    try:\n        message_with_instructions = \"[System Instructions: Be concise]\\n\\nTell me about Python programming.\"\n\n        request_data = {\n            \"message\": message_with_instructions,\n            \"conversation_id\": conversation_id,\n            \"thread_id\": str(uuid.uuid4()),\n            \"model\": \"claude-sonnet-4-5-20250929\",\n            \"extended_thinking\": False,\n        }\n\n        req = Request(\n            f\"{BACKEND_URL}/api/agent/stream\",\n            data=json.dumps(request_data).encode(),\n            headers={\"Content-Type\": \"application/json\"},\n            method=\"POST\",\n        )\n\n        response = urlopen(req, timeout=30)\n\n        # Read SSE stream\n        full_response = \"\"\n        buffer = \"\"\n        for chunk in iter(lambda: response.read(1), b\"\"):\n            buffer += chunk.decode()\n            while \"\\r\\n\\r\\n\" in buffer:\n                event_data, buffer = buffer.split(\"\\r\\n\\r\\n\", 1)\n                lines = event_data.strip().split(\"\\r\\n\")\n\n                event_type = None\n                event_json = None\n                for line in lines:\n                    if line.startswith(\"event: \"):\n                        event_type = line[7:].strip()\n                    elif line.startswith(\"data: \"):\n                        event_json = json.loads(line[6:])\n\n                if event_type == \"message\" and event_json:\n                    full_response += event_json.get(\"content\", \"\")\n\n                if event_type == \"done\":\n                    break\n\n        # Concise responses should be short\n        response_length = len(full_response.strip())\n\n        if response_length < 150:\n            print(f\"   ‚úì Concise response detected (length: {response_length} chars)\")\n            print(f\"   ‚úì Response: {full_response}\")\n            return True\n        else:\n            print(f\"   ‚ö† Response may not be concise (length: {response_length} chars)\")\n            print(f\"   Response: {full_response}\")\n            return \"partial\"\n\n    except Exception as e:\n        print(f\"   ‚úó Concise test failed: {e}\")\n        return False\n\n\ndef test_no_custom_instructions(conversation_id: str):\n    \"\"\"Test 6: Test normal message without custom instructions (control test).\"\"\"\n    print(\"\\n6. Testing normal message without custom instructions (control)...\")\n    try:\n        # Normal message without custom instructions\n        message = \"Hello, how are you?\"\n\n        request_data = {\n            \"message\": message,\n            \"conversation_id\": conversation_id,\n            \"thread_id\": str(uuid.uuid4()),\n            \"model\": \"claude-sonnet-4-5-20250929\",\n            \"extended_thinking\": False,\n        }\n\n        req = Request(\n            f\"{BACKEND_URL}/api/agent/stream\",\n            data=json.dumps(request_data).encode(),\n            headers={\"Content-Type\": \"application/json\"},\n            method=\"POST\",\n        )\n\n        response = urlopen(req, timeout=30)\n\n        # Read SSE stream\n        full_response = \"\"\n        buffer = \"\"\n        for chunk in iter(lambda: response.read(1), b\"\"):\n            buffer += chunk.decode()\n            while \"\\r\\n\\r\\n\" in buffer:\n                event_data, buffer = buffer.split(\"\\r\\n\\r\\n\", 1)\n                lines = event_data.strip().split(\"\\r\\n\")\n\n                event_type = None\n                event_json = None\n                for line in lines:\n                    if line.startswith(\"event: \"):\n                        event_type = line[7:].strip()\n                    elif line.startswith(\"data: \"):\n                        event_json = json.loads(line[6:])\n\n                if event_type == \"message\" and event_json:\n                    full_response += event_json.get(\"content\", \"\")\n\n                if event_type == \"done\":\n                    break\n\n        # Should get a normal response\n        if len(full_response) > 0:\n            print(f\"   ‚úì Normal response received\")\n            print(f\"   ‚úì Response: {full_response[:100]}...\")\n            return True\n        else:\n            print(f\"   ‚úó No response received\")\n            return False\n\n    except Exception as e:\n        print(f\"   ‚úó Normal message test failed: {e}\")\n        return False\n\n\ndef main():\n    \"\"\"Run all tests for Custom Instructions feature.\"\"\"\n    print(\"=\" * 60)\n    print(\"CUSTOM INSTRUCTIONS TEST SUITE\")\n    print(\"Feature #28: Custom instructions for AI responses\")\n    print(\"=\" * 60)\n\n    results = []\n\n    # Test 1: Backend health\n    results.append((\"Backend Health\", test_backend_health()))\n\n    if not results[-1][1]:\n        print(\"\\n‚ùå Backend not running - aborting tests\")\n        return\n\n    # Test 2: Create conversation\n    conversation_id = test_create_conversation()\n    if not conversation_id:\n        print(\"\\n‚ùå Failed to create conversation - aborting tests\")\n        return\n\n    # Test 3: Spanish custom instruction\n    results.append((\"Custom Instructions: Spanish\", test_custom_instructions_spanish(conversation_id)))\n\n    # Test 4: Formal custom instruction\n    results.append((\"Custom Instructions: Formal\", test_custom_instructions_formal(conversation_id)))\n\n    # Test 5: Concise custom instruction\n    results.append((\"Custom Instructions: Concise\", test_custom_instructions_concise(conversation_id)))\n\n    # Test 6: Normal message (control)\n    results.append((\"Normal Message (Control)\", test_no_custom_instructions(conversation_id)))\n\n    # Summary\n    print(\"\\n\" + \"=\" * 60)\n    print(\"TEST SUMMARY\")\n    print(\"=\" * 60)\n\n    passed = sum(1 for _, result in results if result is True)\n    partial = sum(1 for _, result in results if result == \"partial\")\n    failed = sum(1 for _, result in results if result is False)\n\n    for test_name, result in results:\n        status = \"‚úì PASS\" if result is True else (\"‚ö† PARTIAL\" if result == \"partial\" else \"‚úó FAIL\")\n        print(f\"{status}: {test_name}\")\n\n    print(f\"\\nTotal: {passed} passed, {partial} partial, {failed} failed\")\n\n    if passed >= 4:\n        print(\"\\nüéâ CUSTOM INSTRUCTIONS FEATURE IS WORKING!\")\n    elif passed + partial >= 3:\n        print(\"\\n‚úì Custom instructions feature is mostly working\")\n    else:\n        print(\"\\n‚ùå Custom instructions feature needs more work\")\n\n    print(\"=\" * 60)\n\n\nif __name__ == \"__main__\":\n    main()\n