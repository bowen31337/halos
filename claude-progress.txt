# Claude.ai Clone - Development Progress

## Session 14 Summary (DeepAgents Architecture Verification & Bug Fixes)

### Date: 2025-12-27

**Session Focus:** Verified DeepAgents architecture integration, fixed duplicate middleware issue, and updated feature status

### Implementation & Fixes

1. **Fixed Agent Service Middleware Issue** ✅
   - **Location:** `src/services/agent_service.py`
   - **Issue:** Duplicate SubAgentMiddleware causing "duplicate middleware" error
   - **Root Cause:** `create_deep_agent()` already includes SubAgentMiddleware internally
   - **Fix:** Removed SubAgentMiddleware from user-provided middleware stack
   - **Result:** Agent creation now works without errors

2. **Updated Agent Service Documentation** ✅
   - **Location:** `src/services/agent_service.py`
   - **Changes:**
     - Updated docstring to reflect all built-in middleware
     - Added detailed comments about each middleware component
     - Clarified that create_deep_agent provides all core middleware

3. **Verified DeepAgents Architecture** ✅
   - **Test File:** `tests/test_deepagents_architecture.py`
   - **All 14 Steps Passing:**
     1. ✅ deepagents package installed
     2. ✅ create_deep_agent importable
     3. ✅ Agent creation works
     4. ✅ TodoListMiddleware available
     5. ✅ FilesystemMiddleware available
     6. ✅ SubAgentMiddleware available
     7. ✅ SummarizationMiddleware included
     8. ✅ AnthropicPromptCachingMiddleware available
     9. ✅ HumanInTheLoopMiddleware included
     10. ✅ All backends (State, Store, Composite) available
     11. ✅ Agent has invoke() method
     12. ✅ Agent has astream_events() for streaming
     13. ✅ SubAgentMiddleware supports custom subagents
     14. ✅ Long-term memory via CompositeBackend works

4. **Verified Project Custom Instructions** ✅
   - **Test File:** `tests/test_project_custom_instructions.py`
   - **All Tests Passing:**
     - Backend health check
     - Project creation with custom instructions
     - Conversation creation in project
     - Agent with project-specific instructions
     - Control conversation without project
     - Agent without project instructions

### Bug Fixes

1. **Agent Service - Duplicate Middleware** ✅
   - **File:** `src/services/agent_service.py`
   - **Line 119:** Changed `middleware_stack = [SubAgentMiddleware(...)]` to `middleware_stack = []`
   - **Reason:** `create_deep_agent()` already provides SubAgentMiddleware

2. **Feature List - QA Status** ✅
   - **File:** `feature_list.json`
   - **Change:** Feature #37 `is_qa_passed: false` → `is_qa_passed: true`
   - **Reason:** Project custom instructions test passed

### Current Progress

**Total Features:** 201/201
**Completed (Dev):** 37/201 (18.4%)
**Passing:** 37/201 (18.4%)
**QA Passed:** 36/201 (17.9%)

**Verified Features:**
- Features #1-36: Core architecture and basic functionality ✅
- Feature #37: Project-specific custom instructions ✅

### Files Modified

1. `src/services/agent_service.py` - Fixed middleware configuration
2. `feature_list.json` - Updated QA status for feature #37
3. `tests/test_deepagents_architecture.py` - Architecture verification tests
4. `tests/test_project_custom_instructions.py` - Project instructions tests

### Next Steps

**Next Feature to Implement:** #38 - Upload files to project knowledge base

**Pending Features:**
- #38: Upload files to project knowledge base
- #39: Artifact detection renders code artifacts in side panel
- #40: HTML artifact preview with live preview
- #41: SVG artifact renders as graphic
- #42: Mermaid diagram artifact renders correctly
- #43: Download artifact content as file
- #44: Edit artifact and re-prompt for changes
- #45: Artifact version history navigation
- #46: Full-screen artifact view toggle
- #47: Multiple artifacts can be viewed in tabs
- #48: LaTeX/math equations render with KaTeX
- #49-50: Conversation branching features
- And more...

### Technical Notes

**DeepAgents Architecture:**
- **Framework:** LangChain deepagents (langchain-ai/deepagents)
- **Core Function:** `create_deep_agent()` from deepagents package
- **Built-in Middleware:**
  - TodoListMiddleware (write_todos, read_todos)
  - FilesystemMiddleware (ls, read_file, write_file, edit_file, glob, grep)
  - SubAgentMiddleware (task for sub-agent delegation)
  - SummarizationMiddleware (context > 170k tokens)
  - AnthropicPromptCachingMiddleware (cost reduction)
  - HumanInTheLoopMiddleware (tool approval via interrupt_on)
- **Backend:** CompositeBackend (StateBackend + StoreBackend routes)
- **State Management:** LangGraph with MemorySaver

**Agent Service:**
- Creates agents with proper configuration
- Falls back to MockAgent when no API key
- Supports permission modes: default, acceptEdits, plan, bypassPermissions
- Configurable temperature, max_tokens, custom_instructions

---

*Last Updated: Session 14*
*Status: DeepAgents Architecture Verified - Ready for Next Feature Implementation*

## Session 14 Summary (Project-Specific Custom Instructions - Feature #37)

### Date: 2025-12-27

**Session Focus:** Implemented project-specific custom instructions that override global instructions

### Feature Implemented

**Feature #37:** Project-specific custom instructions override global instructions ✓

### Implementation Details

1. **Backend Helper Function** ✓
   - **Location:** `src/api/routes/agent.py`
   - **Function:** `get_effective_custom_instructions(conversation_id, db)`
   - **Logic:**
     - Fetches conversation and its linked project
     - Retrieves project.custom_instructions if available
     - Falls back to global user_settings["custom_instructions"]
     - Returns tuple of (project_instructions, global_instructions)

2. **API Endpoint for Effective Instructions** ✓
   - **Location:** `src/api/routes/settings.py`
   - **Endpoint:** `GET /api/settings/instructions/effective?conversation_id={id}`
   - **Response:**
     ```json
     {
       "project_instructions": "...",
       "global_instructions": "...",
       "effective_instructions": "...",
       "using_project": true/false
     }
     ```

3. **Agent Invoke Endpoint Update** ✓
   - **Location:** `src/api/routes/agent.py`
   - **Changes:**
     - Added `db: AsyncSession = Depends(get_db)` parameter
     - Calls `get_effective_custom_instructions()` to fetch project instructions
     - Uses explicitly provided instructions if given, otherwise uses effective instructions
     - Project instructions override global instructions

4. **Agent Stream Endpoint Update** ✓
   - **Location:** `src/api/routes/agent.py`
   - **Changes:**
     - Added `db: AsyncSession = Depends(get_db)` parameter
     - Calls `get_effective_custom_instructions()` to fetch project instructions
     - Uses explicitly provided instructions if given, otherwise uses effective instructions
     - Project instructions override global instructions

### Test Results

**All Tests Passing:** ✓
```
1. Backend health check - ✓
2. Create project with custom instructions - ✓
3. Create conversation in project - ✓
4. Agent with project instructions - ✓ (Spanish response)
5. Create conversation without project - ✓
6. Agent without project instructions - ✓ (English response)
```

### Files Modified

1. **`src/api/routes/agent.py`**
   - Added `get_effective_custom_instructions()` helper function
   - Updated `invoke_agent()` to use project-specific instructions
   - Updated `stream_agent()` to use project-specific instructions
   - Added `db: AsyncSession` dependency to both endpoints

2. **`src/api/routes/settings.py`**
   - Added imports for database models
   - Added `GET /api/settings/instructions/effective` endpoint
   - Returns project and global instructions with effective merge

3. **`feature_list.json`**
   - Feature #37 marked as complete

4. **`tests/test_project_custom_instructions.py`** (NEW)
   - Comprehensive test suite for project custom instructions
   - Tests project instructions override global
   - Tests fallback to global when no project
   - All tests passing

### Progress Update

- **Previous:** 36/201 features (17.9%)
- **Current:** 37/201 features (18.4%)
- **New Feature:** +1 (Feature #37)

### Feature Behavior

**Priority Order:**
1. Explicitly provided `custom_instructions` in request (highest priority)
2. Project custom instructions (from linked project)
3. Global custom instructions (from user_settings)

**Use Cases:**
- Projects can have specific instructions (e.g., "Always respond in Spanish")
- Global instructions act as default for conversations without projects
- Explicit request parameter overrides both (for special cases)

### Next Steps

Continue with next pending features (38-42):
- Feature #38: Upload files to project knowledge base
- Feature #39: Artifact detection renders code artifacts in side panel
- Feature #40: HTML artifact preview renders correctly with live preview
- Feature #41: SVG artifact renders as graphic in preview

---
